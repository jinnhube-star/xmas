<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cyber-Tree | AI Experience</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap" rel="stylesheet">
    <!-- Load Three.js and Post-Processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.0/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    
    <style>
        :root { --accent: #00ffcc; --bg: #000; }
        body { margin: 0; background: var(--bg); overflow: hidden; font-family: 'Space Mono', monospace; color: white; }
        
        /* UI Layer */
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 10; padding: 30px; }
        #top-info { display: flex; justify-content: space-between; align-items: flex-start; }
        h1 { font-size: 1rem; letter-spacing: 5px; color: var(--accent); margin: 0; text-transform: uppercase; }
        .status-text { font-size: 10px; opacity: 0.5; margin-top: 5px; }

        /* Controls */
        #controls { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; pointer-events: all; }
        .btn { 
            background: transparent; border: 1px solid rgba(0,255,204,0.3); color: var(--accent); 
            padding: 10px 25px; cursor: pointer; transition: 0.3s; font-family: inherit; font-size: 12px;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
        }
        .btn:hover { background: var(--accent); color: black; box-shadow: 0 0 20px var(--accent); }

        /* Camera Preview */
        #v-preview { position: absolute; top: 20px; right: 20px; width: 160px; height: 120px; border: 1px solid var(--accent); opacity: 0.6; transform: scaleX(-1); border-radius: 2px; }
        
        /* Initial Overlay */
        #boot-screen { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #boot-btn { padding: 20px 60px; font-size: 1.2rem; border: 1px solid var(--accent); color: var(--accent); background: transparent; cursor: pointer; }
    </style>
</head>
<body>

<div id="boot-screen">
    <h2 style="color:var(--accent); letter-spacing: 10px; margin-bottom: 40px;">X-MAS_CORE_INITIALIZE</h2>
    <button id="boot-btn">BOOT SYSTEM</button>
</div>

<div id="ui">
    <div id="top-info">
        <div>
            <h1>Neural.Tree_V2</h1>
            <div class="status-text" id="ai-status">AI_HAND_TRACKING: OFFLINE</div>
            <div class="status-text" id="cloud-status">CLOUD_SYNC: WAITING...</div>
        </div>
    </div>
    
    <video id="v-preview" autoplay playsinline></video>

    <div id="controls">
        <label class="btn" for="file-img">Upload_Memory</label>
        <input type="file" id="file-img" multiple accept="image/*">
        <label class="btn" for="file-mp3">Upload_Audio</label>
        <input type="file" id="file-mp3" accept="audio/*">
        <button class="btn" id="clear-btn" style="color:#ff3333; border-color:#ff3333">Wipe_Disk</button>
    </div>
</div>

<audio id="player" loop crossorigin="anonymous"></audio>

<script>
/** 1. SUPABASE CONNECTION **/
const URL_SB = "https://fghbnkjpuoqonnqrtxlm.supabase.co"; 
const KEY_SB = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnaGJua2pwdW9xb25ucXJ0eGxtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1OTc1ODgsImV4cCI6MjA4MjE3MzU4OH0.LkPfFC19GKdQcP2IaZyrymxhF2bNzCwcw-yrjMKqOIw"; 
const sb = supabase.createClient(URL_SB, KEY_SB);

/** 2. THE TECH-TREE SCENE **/
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setClearColor(0x000000, 1);
document.body.appendChild(renderer.domElement);

// Cyber-Spiral Tree (High density particles)
const treeGroup = new THREE.Group();
const pointsCount = 20000;
const positions = new Float32Array(pointsCount * 3);
const originalPositions = new Float32Array(pointsCount * 3);
const colors = new Float32Array(pointsCount * 3);

for (let i = 0; i < pointsCount; i++) {
    const t = i / pointsCount;
    const angle = t * Math.PI * 40; // High spiral
    const radius = (1 - t) * 5;
    
    // NUAA Aesthetic: Double helix structure
    const x = Math.cos(angle) * radius + (Math.random()-0.5)*0.2;
    const y = t * 14 - 7;
    const z = Math.sin(angle) * radius + (Math.random()-0.5)*0.2;

    positions[i*3] = originalPositions[i*3] = x;
    positions[i*3+1] = originalPositions[i*3+1] = y;
    positions[i*3+2] = originalPositions[i*3+2] = z;

    // Cyan to Electric Blue gradient
    colors[i*3] = 0; 
    colors[i*3+1] = 0.5 + (t * 0.5); 
    colors[i*3+2] = 0.8 + (t * 0.2);
}

const geometry = new THREE.BufferGeometry();
geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

const material = new THREE.PointsMaterial({
    size: 0.03,
    vertexColors: true,
    transparent: true,
    blending: THREE.AdditiveBlending,
    opacity: 0.8
});

const treeParticles = new THREE.Points(geometry, material);
treeGroup.add(treeParticles);

// Add "Data-Bells" (Glowing Cubes)
for(let i=0; i<40; i++) {
    const t = Math.random();
    const radius = (1 - t) * 5;
    const angle = Math.random() * Math.PI * 2;
    const box = new THREE.Mesh(
        new THREE.BoxGeometry(0.15, 0.15, 0.15),
        new THREE.MeshBasicMaterial({ color: 0x00ffcc })
    );
    box.position.set(Math.cos(angle)*radius, t*14-7, Math.sin(angle)*radius);
    treeGroup.add(box);
}

scene.add(treeGroup);
camera.position.set(0, 0, 20);

const frameGroup = new THREE.Group();
scene.add(frameGroup);

/** 3. GESTURE ENGINE (MediaPipe) **/
let isExploded = false;
let lastX = 0;

const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7 });

hands.onResults(res => {
    if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
        document.getElementById('ai-status').innerText = "AI_HAND_TRACKING: ACTIVE";
        const h = res.multiHandLandmarks[0];
        
        // Gesture 1: Open Palm (ðŸ–ï¸) -> Explode
        const palmDist = Math.hypot(h[8].x - h[0].x, h[8].y - h[0].y);
        if (palmDist > 0.6 && !isExploded) toggleTree(true);
        if (palmDist < 0.3 && isExploded) toggleTree(false);

        // Gesture 2: Wave (â†”ï¸) -> Rotate
        const dx = (h[0].x - lastX);
        frameGroup.rotation.y -= dx * 10;
        lastX = h[0].x;

        // Gesture 3: Pinch (ðŸ‘Œ) -> Focus
        const pinch = Math.hypot(h[8].x - h[4].x, h[8].y - h[4].y);
        if (pinch < 0.04) gsap.to(camera.position, {z: 10, duration: 1});
        else gsap.to(camera.position, {z: 20, duration: 1});
    }
});

function toggleTree(explode) {
    isExploded = explode;
    const p = treeParticles.geometry.attributes.position.array;
    for (let i = 0; i < pointsCount; i++) {
        gsap.to(p, {
            [i*3]: explode ? (Math.random()-0.5)*50 : originalPositions[i*3],
            [i*3+1]: explode ? (Math.random()-0.5)*50 : originalPositions[i*3+1],
            [i*3+2]: explode ? (Math.random()-0.5)*50 : originalPositions[i*3+2],
            duration: 2, ease: "expo.out",
            onUpdate: () => treeParticles.geometry.attributes.position.needsUpdate = true
        });
    }
}

/** 4. PERSISTENCE (Supabase) **/
const cam = new Camera(document.getElementById('v-preview'), {
    onFrame: async () => await hands.send({image: document.getElementById('v-preview')})
});

document.getElementById('boot-btn').onclick = () => {
    document.getElementById('boot-screen').style.display = 'none';
    cam.start();
    syncCloud();
};

async function upload(file, type) {
    document.getElementById('cloud-status').innerText = "CLOUD_SYNC: UPLOADING...";
    const name = `${Date.now()}_${file.name}`;
    const { data } = await sb.storage.from('xmas').upload(name, file);
    if (data) {
        const { data: urlData } = sb.storage.from('xmas').getPublicUrl(name);
        await sb.from('memories').insert([{ url: urlData.publicUrl, type: type }]);
        location.reload();
    }
}

async function syncCloud() {
    const { data } = await sb.from('memories').select('*');
    if (data) {
        document.getElementById('cloud-status').innerText = "CLOUD_SYNC: OK";
        data.forEach(item => {
            if (item.type === 'image') {
                const tex = new THREE.TextureLoader().load(item.url);
                const frame = new THREE.Mesh(
                    new THREE.PlaneGeometry(3.5, 3.5),
                    new THREE.MeshBasicMaterial({ map: tex, side: 2 })
                );
                const border = new THREE.Mesh(
                    new THREE.PlaneGeometry(3.7, 3.7),
                    new THREE.MeshBasicMaterial({ color: 0x00ffcc, side: 2, wireframe: true })
                );
                const group = new THREE.Group();
                group.add(frame, border);
                const angle = Math.random() * Math.PI * 2;
                group.position.set(Math.cos(angle)*12, (Math.random()-0.5)*10, Math.sin(angle)*12);
                group.lookAt(0,0,0);
                frameGroup.add(group);
            } else {
                const p = document.getElementById('player');
                p.src = item.url; p.play().catch(()=>{});
            }
        });
    }
}

document.getElementById('file-img').onchange = (e) => Array.from(e.target.files).forEach(f => upload(f, 'image'));
document.getElementById('file-mp3').onchange = (e) => upload(e.target.files[0], 'audio');
document.getElementById('clear-btn').onclick = async () => {
    if(confirm("WIPE ENTIRE DATABASE?")) {
        await sb.from('memories').delete().neq('id', 0);
        location.reload();
    }
};

/** 5. RENDER LOOP **/
function animate() {
    requestAnimationFrame(animate);
    treeGroup.rotation.y += 0.005;
    // Pulse effect
    material.size = 0.03 + Math.sin(Date.now()*0.005)*0.01;
    renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
