<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Magical Neon Tree | AI Experience</title>
    <!-- Fonts for the 'NUAA' Tech Look -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono&family=Inter:wght@300;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.0/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        :root { --neon-green: #00ff88; --neon-gold: #ffcc00; --bg: #000000; }
        body { margin: 0; background: var(--bg); overflow: hidden; font-family: 'Inter', sans-serif; color: white; }
        
        /* Minimalist UI */
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 10; padding: 40px; display: flex; flex-direction: column; justify-content: space-between; }
        h1 { font-family: 'Space Mono', monospace; font-size: 1.2rem; letter-spacing: 4px; color: var(--neon-green); text-transform: uppercase; margin: 0; }
        #status { font-size: 0.7rem; color: rgba(255,255,255,0.4); margin-top: 5px; text-transform: uppercase; letter-spacing: 2px; }

        #controls { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; pointer-events: all; }
        .btn { 
            background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 12px 24px; 
            font-size: 0.8rem; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn:hover { border-color: var(--neon-green); color: var(--neon-green); box-shadow: 0 0 15px rgba(0,255,136,0.3); }

        #v-preview { position: absolute; top: 20px; right: 20px; width: 140px; height: 105px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); transform: scaleX(-1); opacity: 0.5; }
        
        #entry-screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #entry-screen h2 { font-family: 'Space Mono'; color: var(--neon-green); margin-bottom: 30px; font-weight: 300; }
        
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div id="entry-screen">
    <h2>INITIALIZING MAGIC...</h2>
    <button class="btn" id="init-btn" style="padding: 20px 50px; font-size: 1rem;">Launch System</button>
</div>

<div id="ui">
    <div>
        <h1>System.Christmas_Tree</h1>
        <div id="status">Syncing with Cloud DB...</div>
    </div>
    
    <video id="v-preview" autoplay playsinline></video>

    <div id="controls">
        <label class="btn" for="file-img">Upload Image</label>
        <input type="file" id="file-img" multiple accept="image/*">
        <label class="btn" for="file-mp3">Upload Audio</label>
        <input type="file" id="file-mp3" accept="audio/*">
        <button class="btn" id="clear-btn" style="color:#ff4444; border-color:#ff444433">Wipe</button>
    </div>
</div>

<audio id="player" loop crossorigin="anonymous"></audio>

<script>
/** 1. CONFIGURATION (STAYS THE SAME) **/
const URL_SB = "https://fghbnkjpuoqonnqrtxlm.supabase.co"; 
const KEY_SB = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnaGJua2pwdW9xb25ucXJ0eGxtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1OTc1ODgsImV4cCI6MjA4MjE3MzU4OH0.LkPfFC19GKdQcP2IaZyrymxhF2bNzCwcw-yrjMKqOIw"; // Replace with your key
const db = supabase.createClient(URL_SB, KEY_SB);

/** 2. TECH-AESTHETIC SCENE **/
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
document.body.appendChild(renderer.domElement);

// Create the Spiral Neon Tree
const treeGroup = new THREE.Group();
const lineCount = 12; // Number of neon strings
const pointsPerLine = 150;

for(let j=0; j<lineCount; j++) {
    const points = [];
    const color = new THREE.Color().setHSL(0.4 + (Math.random()*0.1), 1, 0.5); // Neon greens
    
    for(let i=0; i<pointsPerLine; i++) {
        const r = i / pointsPerLine;
        const angle = i * 0.2 + (j * (Math.PI * 2 / lineCount));
        const radius = (1 - r) * 5;
        points.push(new THREE.Vector3(Math.cos(angle)*radius, r*12 - 6, Math.sin(angle)*radius));
    }
    
    const curve = new THREE.CatmullRomCurve3(points);
    const geometry = new THREE.TubeGeometry(curve, 100, 0.03, 8, false);
    const material = new THREE.MeshBasicMaterial({ color: color, transparent: true, opacity: 0.8 });
    const line = new THREE.Mesh(geometry, material);
    line.userData.originalPoints = points.map(p => p.clone()); // Store for gestures
    treeGroup.add(line);
}

// Glowing Star (Low-poly tech style)
const starGeo = new THREE.IcosahedronGeometry(0.6, 0);
const starMat = new THREE.MeshBasicMaterial({ color: 0xffcc00 });
const star = new THREE.Mesh(starGeo, starMat);
star.position.y = 6.5;
treeGroup.add(star);
scene.add(treeGroup);

camera.position.set(0, 0, 22);

const photoGroup = new THREE.Group();
scene.add(photoGroup);

/** 3. GESTURE LOGIC (IMPROVED) **/
let exploded = false;
let lastHandX = 0;

function handleGestures(res) {
    if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
        const h = res.multiHandLandmarks[0];
        const dist = Math.hypot(h[8].x - h[0].x, h[8].y - h[0].y); // Finger tip to wrist
        
        // OPEN PALM = EXPLODE | FIST = REASSEMBLE
        if (dist > 0.6 && !exploded) toggleTree(true);
        if (dist < 0.25 && exploded) toggleTree(false);

        // WAVE = ROTATE
        const movement = (h[0].x - lastHandX);
        photoGroup.rotation.y -= movement * 10;
        lastHandX = h[0].x;

        // PINCH = ZOOM
        const pinch = Math.hypot(h[8].x - h[4].x, h[8].y - h[4].y);
        if (pinch < 0.04) gsap.to(camera.position, {z: 10, duration: 1});
        else gsap.to(camera.position, {z: 22, duration: 1});
    }
}

function toggleTree(state) {
    exploded = state;
    document.getElementById('status').innerText = exploded ? "STATE: DECONSTRUCTED" : "STATE: STABLE";
    
    treeGroup.children.forEach(line => {
        if(!line.geometry.attributes.position) return;
        const pos = line.geometry.attributes.position;
        for(let i=0; i<pos.count; i++) {
            const tx = state ? (Math.random()-0.5)*40 : line.userData.originalPoints[Math.floor(i/8)]?.x || 0;
            const ty = state ? (Math.random()-0.5)*40 : line.userData.originalPoints[Math.floor(i/8)]?.y || 0;
            const tz = state ? (Math.random()-0.5)*40 : line.userData.originalPoints[Math.floor(i/8)]?.z || 0;
            
            gsap.to(pos.array, {
                [i*3]: tx, [i*3+1]: ty, [i*3+2]: tz,
                duration: 2, ease: "expo.inOut",
                onUpdate: () => pos.needsUpdate = true
            });
        }
    });
}

/** 4. SUPABASE SYNC (UNCHANGED) **/
async function upload(file, type) {
    document.getElementById('status').innerText = "CLOUD_UPLOADING...";
    const name = `${Date.now()}_${file.name}`;
    const { data } = await db.storage.from('xmas').upload(name, file);
    if (data) {
        const { data: urlData } = db.storage.from('xmas').getPublicUrl(name);
        await db.from('memories').insert([{ url: urlData.publicUrl, type: type }]);
        location.reload();
    }
}

async function loadMemories() {
    const { data } = await db.from('memories').select('*');
    if (data) data.forEach(item => {
        if (item.type === 'image') {
            const tex = new THREE.TextureLoader().load(item.url);
            // Fancy Picture Frames (White border)
            const frame = new THREE.Mesh(new THREE.PlaneGeometry(3.2, 3.2), new THREE.MeshBasicMaterial({color: 0xffffff}));
            const img = new THREE.Mesh(new THREE.PlaneGeometry(3, 3), new THREE.MeshBasicMaterial({map: tex}));
            img.position.z = 0.01;
            const container = new THREE.Group();
            container.add(frame, img);
            const a = Math.random() * Math.PI * 2;
            container.position.set(Math.cos(a)*12, (Math.random()-0.5)*10, Math.sin(a)*12);
            container.lookAt(0,0,0);
            photoGroup.add(container);
        } else {
            document.getElementById('player').src = item.url;
            document.getElementById('player').play().catch(()=> {
                document.getElementById('status').innerText = "AUDIO_PAUSED: CLICK UI";
            });
        }
    });
}

/** 5. INITIALIZATION & LOOP **/
document.getElementById('init-btn').onclick = () => {
    document.getElementById('entry-screen').style.display = 'none';
    cam.start();
    loadMemories();
    document.getElementById('status').innerText = "SYSTEM_ONLINE";
};

const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({ maxNumHands: 1, modelComplexity: 1 });
hands.onResults(handleGestures);
const cam = new Camera(document.getElementById('v-preview'), { onFrame: async () => await hands.send({image: document.getElementById('v-preview')}) });

document.getElementById('file-img').onchange = (e) => Array.from(e.target.files).forEach(f => upload(f, 'image'));
document.getElementById('file-mp3').onchange = (e) => upload(e.target.files[0], 'audio');
document.getElementById('clear-btn').onclick = async () => {
    if(confirm("Wipe all data?")) {
        await db.from('memories').delete().neq('id', 0);
        location.reload();
    }
}

function animate() {
    requestAnimationFrame(animate);
    treeGroup.rotation.y += 0.005;
    star.rotation.z += 0.05;
    renderer.render(scene, camera);
}
animate();

window.onresize = () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
};
</script>
</body>
</html>
